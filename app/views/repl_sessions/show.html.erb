<% content_for(:title, @repl_session) %>

<%= turbo_stream_from(@repl_session) %>

<div class="p">
  <div class="text-gray-600"><%= t(".id") %></div>
  <div class="font-bold"><%= @repl_session.id %></div>
</div>

<% if @repl_session.user.present? %>
  <div class="p">
    <div class="text-gray-600"><%= t(".user") %></div>
    <%= render("shared/user", user: @repl_session.user) %>
  </div>
<% end %>

<% if @repl_session.name.present? %>
  <div class="p">
    <div class="text-gray-600"><%= t(".name") %></div>
    <div class="font-bold"><%= @repl_session.name %></div>
  </div>
<% end %>

<div class="p">
  <div class="text-gray-600"><%= t(".updated_at") %></div>
  <div class="font-bold"><%= local_time(@repl_session.updated_at) %></div>
</div>

<div class="p">
  <div class="text-gray-600"><%= t(".created_at") %></div>
  <div class="font-bold"><%= local_time(@repl_session.created_at) %></div>
</div>

<div class="p">
  <%= link_to(t(".edit"), edit_url, class: "link") %>
  <%= render("shared/confirm", text: t(".delete"), url: show_url) %>
</div>

<div class="p font-bold">
  <%= link_to(
    t(".repl_programs"),
    [@user, @repl_session, :repl_programs],
    class: "link"
  ) %>
</div>

<div class="p">
  <%= link_to(
    t(".new_repl_program"),
    [:new, @user, @repl_session, :repl_program],
    class: "button"
  ) %>
</div>

<% (@repl_programs + [@repl_program]).each do |repl_program| %>
  <% repl_prompt = repl_program.repl_prompts.last || ReplPrompt.new %>
  <% generate = repl_prompt.generating? ? t(".generating") : t(".generate") %>

  <%= form_for(
    [@user, @repl_session, repl_program],
    data: {
      controller: "editor",
      action: "turbo:morph@window->editor#reconnect"
    }
  ) do |f| %>
    <%= f.hidden_field(:repl_session_id) %>
    <%= f.hidden_field(:context, value: "repl_sessions#show") %>

    <div class="p flex items-center gap-4">
      <div class="w-full border border-black rounded overflow-hidden">
        <%= f.hidden_field(:input, data: { editor_target: "input" }) %>
        <div data-editor-target="editor"></div>
      </div>

      <%= f.submit(generate, name: "repl_program[generate]", class: "button") %>

      <%= f.submit(t(".evaluate"), class: "button") %>
    </div>

    <div class="text-red-600" data-editor-target="error"></div>

    <%= render(
      partial: "repl_executions/repl_execution",
      collection: repl_program.repl_executions,
      as: :repl_execution,
      locals: {
        nested: [@user, @repl_session, repl_program]
      }
    ) %>
  <% end %>
<% end %>

<div class="p">
  <%= button_to(t(".evaluate_all"), [*show_url, :evaluate], class: "button") %>
</div>
